CREATE OR REPLACE PROCEDURE CalcSuc(
    p_Cod_sucursal  IN      Sucursal.Cod_sucursal%TYPE,
    p_montoAprobado IN      Prestamo.Monto_Aprobado%TYPE)
    AS
    
    
    v_cantidad              Sucursal.cantidad%TYPE;
    v_montoprestamo         Sucursal.monto_prestamo%TYPE;
    CURSOR c_sucursal IS
        SELECT Cantidad, Monto_prestamo
        FROM sucursal
        WHERE cod_sucursal = p_Cod_sucursal;
BEGIN
    OPEN c_sucursal;
    LOOP
        FETCH c_sucursal INTO v_cantidad, v_montoprestamo;
        EXIT WHEN c_sucursal%NOTFOUND;
        UPDATE Sucursal
        SET Cantidad = v_cantidad + 1, Monto_prestamo = v_montoprestamo+p_montoAprobado
        WHERE Cod_sucursal = p_Cod_sucursal;
    END LOOP;
    CLOSE c_sucursal;
END CalcSuc;
/

CREATE OR REPLACE PROCEDURE CalcTipoSuc(
    p_Cod_sucursal  IN      Sucursal_Tipoprestamo.Cod_sucursal%TYPE,
    p_montoAprobado IN      Prestamo.Monto_Aprobado%TYPE,
    p_TipoPrestamo  IN      Sucursal_Tipoprestamo.Tipo_Prestamo%TYPE
    )
    AS

    v_cantidad              Sucursal.cantidad%TYPE;
    v_montoprestamo         Sucursal.monto_prestamo%TYPE;
    CURSOR c_Tsucursal IS
        SELECT Cantidad, Monto_prestamo
        FROM Sucursal_Tipoprestamo
        WHERE cod_sucursal = p_Cod_sucursal AND Tipo_prestamo = p_TipoPrestamo;
BEGIN
    OPEN c_Tsucursal;
    LOOP
        FETCH c_Tsucursal INTO v_cantidad, v_montoprestamo;
        EXIT WHEN c_Tsucursal%NOTFOUND;
        UPDATE Sucursal_Tipoprestamo
        SET Cantidad = v_cantidad + 1, Monto_prestamo = v_montoprestamo+p_montoAprobado
        WHERE Cod_sucursal = p_Cod_sucursal AND Tipo_prestamo = p_TipoPrestamo;
    END LOOP;
    CLOSE c_Tsucursal;
END CalcTipoSuc;
/

CREATE OR REPLACE PROCEDURE Prestamos_Aprobados(
    p_idCliente          IN   Prestamo.ID_Cliente%TYPE,
    p_idTipoPrestamos    IN   Prestamo.ID_TipoPrestamo%TYPE,
    p_numPrestamo        IN   Prestamo.Num_Prestamo%TYPE,
    p_fechaAprobado      IN   Prestamo.Fecha_Aprobado%TYPE,
    p_montoAprobado      IN   Prestamo.Monto_Aprobado%TYPE,
    p_tasaInteres        IN   Prestamo.Tasa_Interes%TYPE,
    p_letraMensual       IN   Prestamo.Letra_Mensual%TYPE,
    p_MontoPagado        IN   Prestamo.Monto_Pagado%TYPE,
    p_fechaPago          IN   Prestamo.Fecha_Pago%TYPE,
    p_codSucursal        IN   Prestamo.Cod_sucursal%TYPE,
    p_saldoActual        IN   Prestamo.Saldo_actual%TYPE,
    p_interesPagado      IN   Prestamo.Interes_pagado%TYPE,
    p_fechaModificacion  IN   Prestamo.Fecha_modificacion%TYPE) AS

BEGIN
    INSERT INTO Prestamo
    VALUES(p_idCliente, p_idTipoPrestamos, p_numPrestamo, p_fechaAprobado, p_montoAprobado, p_tasaInteres, p_letraMensual,
    p_MontoPagado, p_fechaPago, p_codSucursal, p_saldoActual, p_interesPagado, p_fechaModificacion, user);

    CalcSuc(p_codSucursal, p_montoAprobado);
    CalcTipoSuc(p_codSucursal, p_montoAprobado, p_idTipoPrestamos);
    
END Prestamos_Aprobados;
/