CREATE OR REPLACE PROCEDURE interes()
    AS
CURSOR c_searchpago IS
SELECT clienteID, tipo_prestamoID, monto_del_pago
FROM transacpagos
WHERE Status = 'N';
v_cliente           transacpagos.clienteID%TYPE;
v_Tipo_Prestamo     transacpagos.tipo_prestamoID%TYPE;
v_Montodepago       transacpagos.monto_del_pago%TYPE;
v_Saldo_actual      prestamo.saldoactual%TYPE;
v_Interes_pagado    prestamo.interespagado%TYPE;
v_tasa              prestamo.tasa_interes%TYPE;
v_montopagado       prestamo.monto_pagado%TYPE;
BEGIN
	OPEN c_searchpago;
	LOOP
		FETCH c_searchpago INTO v_cliente, v_Tipo_Prestamo, v_Montodepago;
		EXIT WHEN c_searchpago%NOTFOUND;
        SELECT saldoactual, interespagado, tasa_interes, monto_pagado 
        INTO v_Saldo_actual, v_Interes_pagado, v_tasa, v_montopagado
        FROM prestamo
        WHERE clienteID = v_cliente AND tipo_prestamoID = V_Tipo_Prestamo;
        UPDATE prestamo
        SET saldo_actual=calculo_saldoactual(v_Saldo_actual, v_montodepago, v_tasa), 
        Interes_pagado= calculo_interes(v_Saldo_actual,v_tasa), 
        Monto_Pagado= calculo_montopagado(v_montopagado, v_montodepago, v_saldo_actual, v_tasa)
        WHERE clienteID = v_cliente AND tipo_prestamoID = p_tipo_prestamo;
    END LOOP;
    CLOSE c_findpago;

END actpago;
/

--Funcion que calcula el interes
CREATE OR REPLACE FUNCTION calculo_interes(
    p_saldo_actual IN prestamo.saldo_actual%TYPE,
    p_tasa IN prestamo.tasa_interes%TYPE)
    RETURN prestamo.interes_pagado%TYPE IS 
BEGIN
    RETURN p_Saldo_actual*p_tasa;
END calculo_interes;

--Funcion que calcula el saldo actual
CREATE OR REPLACE FUNCTION calculo_saldoactual(
    p_saldo_actual IN prestamo.saldoactual%TYPE,
    p_montodepago IN transacpagos.monto_del_pago%TYPE,
    p_tasa IN prestamo.tasa_interes%TYPE)
    RETURN prestamo.saldoactual%TYPE IS 
BEGIN
    RETURN p_Saldo_actual-(p_montodepago-(p_saldo_actual*p_tasa));
END calculo_saldoactual;

--Funcion que calcula el monto pagado
CREATE OR REPLACE FUNCTION calculo_montopagado(
    p_montopagado IN prestamo.monto_pagado%TYPE,
    p_montodepago IN transacpagos.monto_del_pago%TYPE,
    p_saldo_actual IN prestamo.saldoactual%TYPE,
    p_tasa IN prestamo.tasa_interes%TYPE)
    RETURN prestamo.saldoactual%TYPE IS 
BEGIN
    RETURN p_montopagado + (p_montodepago-(p_saldo_actual*p_tasa));
END calculo_montopagado;



