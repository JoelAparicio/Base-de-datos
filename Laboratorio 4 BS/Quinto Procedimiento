CREATE OR REPLACE PROCEDURE actuapresta
AS
v_cliente transacpagos.id_cliente%TYPE;
v_tipop transacpagos.tipoprestamo%TYPE;
v_montopago transacpagos.monto_del_pago%TYPE;
v_fecha transacpagos.fechainsercion%TYPE;
CURSOR c_pago IS
SELECT * FROM transacpagos;
v_saldoprestamo prestamo.saldo_actual%TYPE;
v_interes tipo_prestamo.tasa_interes%TYPE;
v_interestotal tipo_prestamo.tasa_interes%TYPE;
v_nuevo prestamo.saldo_actual%TYPE;
v_montoacum prestamo.monto_pagado%TYPE;
v_interacum prestamo.interes_pagado%TYPE;
BEGIN
v_montoacum :=0;
v_interacum :=0;
FOR v_pagodato IN c_pago LOOP
v_cliente:= v_pagodato.id_cliente;
v_tipop := v_pagodato.tipoprestamo;
v_montopago := v_pagodato.monto_del_pago;
SELECT saldo_actual INTO v_saldoprestamo FROM prestamo --saldo del prestamo
WHERE id_cliente=v_cliente AND tipo=v_tipop;
SELECT tasa_interes INTO v_interes FROM tipo_prestamo ---interes fijo del tipo de prestamo
WHERE tipo=v_tipop;
v_interestotal:=tasainteres(v_saldoprestamo,v_interes); --calculo del interes del prestamo
v_nuevo:=v_interestotal-v_montopago; --resta el pago del interes
IF(v_nuevo<0) THEN --lo que sobra se le resta al salgdo actual
v_nuevo:=(v_nuevo*-1);
v_nuevo:=v_saldoprestamo-v_nuevo;
UPDATE prestamo SET saldo_actual=v_nuevo WHERE id_cliente=v_cliente AND tipo=v_tipop;
UPDATE prestamo SET fecha_pago=v_pagodato.fechatransaccion WHERE id_cliente=v_cliente AND tipo=v_tipop;
UPDATE prestamo SET fecha_modificacion=sysdate WHERE id_cliente=v_cliente AND tipo=v_tipop;
v_montoacum:=v_montoacum+v_montopago;
v_interacum:=v_interacum+v_interestotal;
UPDATE prestamo SET monto_pagado=v_montoacum WHERE id_cliente=v_cliente AND tipo=v_tipop;
UPDATE prestamo SET interes_pagado=v_interacum WHERE id_cliente=v_cliente AND tipo=v_tipop;
UPDATE prestamo SET usuario=v_pagodato.usuario WHERE id_cliente=v_cliente AND tipo=v_tipop;
END IF;
END LOOP;
END actuapresta;
/
SELECT * FROM prestamo;
BEGIN
actuapresta();
END;
/
SELECT * FROM prestamo;